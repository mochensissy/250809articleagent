### 任务：250809文章创作agent（公众号优先 / 两次人工确认 / 文本先审图后生）

本任务基于 `prd/文章创作Agent_PRD.md` 实施，分阶段落地自动化写作闭环：素材→大纲→文本→配图→草稿上传。默认文本模型为 Perplexity，配图使用豆包图像API，平台为微信公众号草稿上传。

---

## 一、里程碑（Milestones）

- M0（已完成）：PRD定稿
- M1：目录与配置骨架（进行中 / 已创建 config、Templates、prompts；新增示例任务目录与状态文件）
- M2：要素提取与记忆检索（含 `.ingested`）
- M3：公众号爆款模式参考 + 大纲生成 + 人工确认A
- M4：写作剧本 + 分章扩写 + 事实核查 + 文本审稿包 + 人工确认B
- M5：配图（豆包） + 转HTML + 公众号草稿上传
- M6：稳定性优化 + 模板/风格库完善 + 回归测试

---

## 二、前置准备（环境与配置）

- [ ] 创建 `.env`（参考 `config/.env.example`）并填入：
  - `PERPLEXITY_API_KEY`
  - `DOUBAO_IMAGE_API_KEY`、`DOUBAO_IMAGE_API_URL`
  - `WECHAT_APPID`、`WECHAT_APPSECRET`
  - 可选：`TEXT_LLM_BASE_URL`（如走OpenAI兼容网关）
- [ ] 公众号后台设置服务器IP白名单
- [ ] 在 `config/agent_config.json` 确认开关：
  - `review.gate_outline=true`、`review.gate_text=true`
  - `verification.enabled=true`、`verification.strictness=normal`
  - `ingestion.trigger=command`
  - `text_llm.provider=perplexity`、`images.provider=doubao`
- [ ] 在 `config/wechat_config.json` 配置作者、摘要策略、是否显示封面

验收：环境变量正确加载，能请求 Perplexity / 豆包 / 公众号 token 接口（连通性OK）。
进度更新：
- 已创建 `config/agent_config.json`、`config/wechat_config.json`、`config/env.example`
- 已创建 `Templates/`（含 `prompts/` 模板与平台风格、流程模板）
- 已创建示例任务目录：`Articles/进行中/示例文章/Materials/`、`workflow_state.json`
- 已创建记忆库骨架：`Memories/{Contents,Examples,.ingested}/`

---

## 三、目录初始化（M1）

- [ ] 生成或校验以下目录：
  - `Articles/进行中/<文章标题>/Materials/`
  - `Memories/{Contents,Examples,.ingested}/`
  - `Templates/{prompts,article_creation.md,article_elements_extraction.md,platform_styles_lib.json}`
  - `config/{agent_config.json,wechat_config.json,.env.example}`
- [ ] 为 `<文章标题>` 创建 `workflow_state.json`（初始 `current_step=init`）
- [ ] 初始化统一待办清单 `article_creation.md`（由模板拷贝），并在关键阶段联动勾选
- [ ] 准备 `Templates/prompts` 的Prompt片段（大纲/扩写/核查）

验收：执行 `agent outline` 前，目录存在且状态文件生成成功。
进度更新：上述目录与占位文件已创建。

---

## 四、要素提取与记忆检索（M2）

任务分解：
- [ ] 素材抽取：将 `Materials/` 中的 `transcript.*`、`notes.md`、`links.txt`、`facts.json` 统一清洗合并
- [ ] 生成 `extracted_meta.json`：主题、受众、目标、关键点、风格、SEO关键词
- [ ] 记忆库抽取：将 `Memories/Contents`、`Examples` 中的 `.md/.txt/.docx/.pdf` 抽取成纯文本入 `.ingested/`
- [ ] 生成/更新 `memory_indexing.json`（文件级元信息、标签、口吻、关键词）
- [ ] 风格匹配：按关键词/标签匹配出自有Top2、案例Top1-2，写入 `workflow_state.json.memory_basis`

验收：`extracted_meta.json` 与 `.ingested/` 与 `memory_indexing.json` 正常产出；`memory_basis` 字段存在且引用可读。

---

## 五、公众号爆款模式参考 + 大纲生成 + 人工确认A（M3）

任务分解：
- [ ] 生成检索Query（含 `site:mp.weixin.qq.com`，基于 `extracted_meta` 的主题/关键词）
- [ ] 调用 Perplexity：返回候选文章，抽取“标题钩子/结构套路/表达手法”，生成 `market_references.json`
- [ ] 大纲生成：融合“记忆基准 + 爆款模式 + 平台风格”，产出 `article_structure.md`（含5个备选标题）
- [ ] 更新状态：`steps.outline=pending_review`
- [ ] 人工确认A：你审阅大纲，执行 `agent approve outline` 或标记状态为 `approved`
 - [ ] Checklist联动：在 `article_creation.md` 对应条目自动勾选（生成大纲/人工确认A）

验收：大纲质量满足预期；人工确认后流转到写作剧本阶段。

---

## 六、写作剧本 + 分章扩写 + 事实核查 + 文本审稿包 + 人工确认B（M4）

任务分解：
- [ ] 生成 `article_writing.md`：将大纲拆为原子任务（章节/子任务/输入/输出锚点）
- [ ] 扩写器：按章节生成正文（文本Only），每章完成后立即进入核查
- [ ] 事实核查（逐章）：
  - 抽取高风险断言（数字、时效、引述、实体、因果）
  - Perplexity 检索验证（白名单域：`mp.weixin.qq.com`），打分与证据摘要
  - 低置信度段落改写或标注复审
  - 产出 `verification_reports/chapter-XX.json`，并汇总 `verification_reports/summary.md`
- [ ] 汇总 `article_draft_text_only.md`，更新状态 `steps.draft_text=ready_for_review`
- [ ] 人工确认B（文本）：你审阅纯文本与核查报告 → `agent approve draft-text`

验收：文本通过后进入配图；若退回，允许你手改后重跑 `agent draft --text-only`，不覆盖你的改动。

---

## 七、配图（豆包） + 转HTML + 公众号草稿上传（M5）

任务分解：
- [ ] 生成 `image_plan.json`：封面 + 每章1图的提示词/alt/关键词
- [ ] 调用豆包图像API生成图片，保存至 `images/`，统一命名
- [ ] 在文本中插入图片，生成 `article_draft.md`
- [ ] Markdown→HTML（处理标题、列表、图片）
- [ ] 上传正文图片（`/cgi-bin/media/uploadimg`）获取URL，并替换HTML中的本地路径
- [ ] 上传封面素材（`/cgi-bin/material/add_material`）获取 `media_id`
- [ ] 组装草稿结构并调用 `/cgi-bin/draft/add`，记录返回 `draft_id`
- [ ] 写入 `outputs/final.md` 与 `outputs/preview.html`，状态 `steps.wechat_draft=done`

验收：草稿创建成功并可在公众号后台预览；本地 `final.md` 与 `preview.html` 可读。

---

## 八、稳定性与回归（M6）

- [ ] 错误与重试：对外部接口增加退避重试与错误分级日志
- [ ] 速率限制：串行/节流，避免命中QPS限制
- [ ] 模板与风格库完善：`Templates/prompts`、`platform_styles_lib.json`
- [ ] 回归测试：从素材→草稿全链路至少跑3次，覆盖成功/失败/恢复场景

验收：三条全链路均通过；错误日志清晰；可断点恢复。

---

## 九、命令与触发

- `agent outline`：素材→要素提取→记忆检索→公众号模式参考→大纲
- `agent approve outline`：大纲通过→写作剧本
- `agent draft --text-only`：分章扩写→核查→文本审稿包
- `agent approve draft-text`：文本通过→配图→转HTML→草稿上传
- 可选：`agent images`、`agent wechat-draft`（手动触发单阶段）

默认触发方式：命令式；监听模式（watch）可选开关。

---

## 十、测试用例（示例）

- [ ] 正常流：提供 `transcript.md` → 一次确认大纲、一次确认文本 → 生成配图并上传草稿成功
- [ ] 数据校验：断言包含时间/数字/引用，低置信度被改写或标注复审
- [ ] 失败恢复：在第2章写作后中断，重启可从下一章继续
- [ ] 图片失败：豆包API失败→降级生成 `image_plan.json` 和占位符
- [ ] 公众号接口失败：token过期/图片上传失败→自动重试并记录错误

---

## 十一、Definition of Done（关键阶段）

- M3 DoD：`article_structure.md` + `market_references.json` 完成并通过人工确认A
- M4 DoD：`article_draft_text_only.md` + `verification_reports/summary.md` 完成并通过人工确认B
- M5 DoD：`article_draft.md`（含图）生成，公众号草稿 `draft_id` 返回，`final.md` 与 `preview.html` 落盘

---

## 十二、风险与缓解

- 检索不稳定：Perplexity为主；必要时提供站内检索后备开关
- 事实偏差：逐章核查、strict模式可选、人审B兜底
- 公众号限制：IP白名单、素材规范；失败重试与详尽日志
- 图片生成不匹配：允许人工替换 `images/`，再次生成HTML与草稿



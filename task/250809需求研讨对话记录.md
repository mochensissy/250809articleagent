### 250809需求研讨对话记录（文章创作Agent / 公众号优先 / 两次人工确认）

本记录整理自本次在 Cursor 的完整对话与共识，服务于 `250809文章创作agent` 的设计与落地。

---

## 1. 背景与目标

- 目标：以最少人机交互完成公众号文章从素材到草稿上传的自动化闭环，保证质量、风格统一与事实可靠。
- 场景：
  - 输入以“语音转文字稿”为主，可附 notes/links/facts 等素材
  - 输出为“含配图的公众号草稿”，并完成公众号“新增草稿”上传
- 成功标准（MVP）：1小时内从素材到“已上传草稿”；两次人工确认（大纲、纯文本）；配图（封面+每章1图）。

---

## 2. 最终共识（关键决策）

- 两次人工确认：
  - A：大纲确认（必须）
  - B：纯文本确认（必须，文本通过后再生成配图）
- 参考来源：
  - 公众号爆款优先，通过 `site:mp.weixin.qq.com` 检索，仅做“模式摘要”（标题钩子/结构套路/表达手法），不落地第三方原文
- 模型与API：
  - 文本：Perplexity 统一负责检索/总结/生成/事实核查
  - 图片：豆包图像API（封面+每章1图）
  - 公众号：仅“新增草稿”，不自动发布
- 断点策略：
  - 强制停点：大纲A、文本B
  - 内部章节级断点（容错用，不打扰）
- 记忆库格式：不强制 Markdown；任意格式（md/txt/docx/pdf）抽取为 `.ingested/` 供检索
- 触发方式：命令式为默认（`agent outline` → `agent draft --text-only` 等）；监听模式可选

---

## 3. 争议点与结论（问答摘录）

- Q：Perplexity 是否有侵权风险？
  - A：默认只做“模式摘要”，不存原文片段；最终文本融合“个人风格 + 你提供素材”。

- Q：记忆检索用关键词还是向量？
  - A：MVP先关键词/标签匹配，向量检索作为后续增强开关。

- Q：配图策略如何选？
  - A：用豆包图像API自动生成真实图片；若失败，降级为“配图计划 + 占位符”。

- Q：Bing vs Perplexity？
  - A：默认不用Bing，Perplexity承担检索/总结/生成/核查；Bing仅作为可选后备。

- Q：断点粒度是什么？
  - A：指中断恢复的颗粒度。本项目强制停在“大纲A、文本B”，内部按“章节级”记录进度。

- Q：Cursor 是否直接充当模型接口？
  - A：为实现无人值守，需要脚本直接调模型API。默认使用 Perplexity API 统一承载文本能力。

---

## 4. 最终流程（文本先审，图后生）

1) 初始化：创建任务空间与 `workflow_state.json`
2) 要素提取：从 `Materials/` 抽取→`extracted_meta.json`
3) 记忆检索（风格匹配，80/20）：自有Top2 + 案例Top1-2
4) 公众号爆款模式参考：`site:mp.weixin.qq.com` 检索→`market_references.json`
5) 生成大纲：`article_structure.md` → 人工确认A（停）
6) 写作剧本：生成 `article_writing.md`
7) 分章扩写 + 事实核查（逐章）：产出 `article_draft_text_only.md` 与 `verification_reports/`
8) 人工确认B（纯文本审稿包，停）
9) 配图（豆包）：`image_plan.json` → 生成 `images/` → 插入 → `article_draft.md`
10) 转HTML + 上传图片与封面 + 公众号“新增草稿”

---

## 5. 产物与状态机（核心文件）

- 产物：
  - `extracted_meta.json`、`market_references.json`
  - `article_structure.md`（A）、`article_writing.md`
  - `article_draft_text_only.md`（B）、`verification_reports/*`
  - `image_plan.json`、`images/*`、`article_draft.md`
  - `outputs/final.md`、`outputs/preview.html`
- 状态文件：`workflow_state.json`
  - `steps.outline: pending_review|approved`
  - `steps.draft_text: ready_for_review|approved`
  - `steps.images: planned|generated|embedded`
  - `steps.wechat_draft: pending|done`
  - `checkpoints.last_chapter_done: <index>`

---

## 6. 配置与密钥（.env）

- 必需：`PERPLEXITY_API_KEY`、`DOUBAO_IMAGE_API_KEY`、`WECHAT_APPID`、`WECHAT_APPSECRET`
- 可选：`TEXT_LLM_BASE_URL`（如OpenAI兼容网关）、Bing键（若启用后备）

---

## 7. 命令入口（CLI）

- `agent outline`：素材→要素→记忆→爆款模式→大纲（置A待审）
- `agent approve outline`：A通过→写作剧本
- `agent draft --text-only`：分章扩写→核查→文本审稿包（置B待审）
- `agent approve draft-text`：B通过→配图→转HTML→草稿上传
- 可选：`agent images`、`agent wechat-draft`

---

## 8. 里程碑 & DoD（摘录）

- M3 DoD：`article_structure.md` + `market_references.json` 完成并通过A
- M4 DoD：`article_draft_text_only.md` + `verification_reports/summary.md` 完成并通过B
- M5 DoD：`article_draft.md`（含图）生成，公众号 `draft_id` 返回，`final.md` 与 `preview.html` 落盘

---

## 9. 参考仓库

- GitHub 远程仓库（空仓待推送）：[`mochensissy/250809articleagent`](https://github.com/mochensissy/250809articleagent.git)


